<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Checker EOL & CVEs</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  body {
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    margin: 0; padding: 0; background:#f4f6f8; color:#1f2328;
  }
  main { max-width: 720px; margin: 3rem auto; padding: 2rem; background:#fff; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.08);}
  h1 { font-size: 2rem; color:#0a84ff; margin-bottom:1rem; }
  h3 { margin-top:1rem; color:#0a7; }
  form label { display:block; margin-top:1rem; font-weight:600; }
  input, select { width:100%; padding:0.6rem 0.8rem; margin-top:0.3rem; border:1px solid #d0d7de; border-radius:8px; }
  button { margin-top:1rem; padding:0.7rem 1.5rem; background:#0a84ff; color:#fff; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:0.2s; }
  button:hover { background:#006edc; }
  .panel { margin-top:1.5rem; padding:1rem 1.2rem; border-radius:8px; background:#f9f9f9; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
  .tag { display:inline-block; padding:.25rem .5rem; margin-right:.3rem; border-radius:6px; font-size:.85rem; font-weight:600; color:#fff; }
  .sev-CRITICAL { background:#c00; }
  .sev-HIGH { background:#e67e22; }
  .sev-MEDIUM { background:#f1c40f; color:#111; }
  .sev-LOW { background:#2ecc71; color:#111; }
  .sev-NA { background:#999; }
  a { color:#0a84ff; text-decoration:none; }
  a:hover { text-decoration:underline; }
  .muted { color:#555; }
  .bad { color:#c00; font-weight:bold; }
</style>
</head>
<body>
<main>
  <h1>Checker de soporte y CVEs</h1>
  <form id="form">
    <label>Tecnología</label>
    <input id="tec" placeholder="Angular" value="Angular" required />
    <label>Versión</label>
    <input id="ver" placeholder="16.2.0" value="16.2.0" required />
    <label>Filtrar CVEs por severidad</label>
    <select id="sev">
      <option value="">Todas</option>
      <option value="HIGH">HIGH + CRITICAL</option>
      <option value="CRITICAL">CRITICAL</option>
    </select>
    <button type="submit">Consultar</button>
  </form>
  <section id="out" class="panel"></section>
</main>
<script>
const out = document.getElementById('out');
const fmtDate = d => d ? new Date(d).toLocaleDateString() : '-';
const cap = s => s ? s.charAt(0).toUpperCase() + s.slice(1) : '';
const sevTag = sev => `<span class="tag sev-${(sev||"NA").toUpperCase()}">${(sev||"NA").toUpperCase()}</span>`;

document.getElementById('form').addEventListener('submit', async ev => {
  ev.preventDefault();
  const tec = document.getElementById('tec').value.trim();
  const ver = document.getElementById('ver').value.trim();
  const sev = document.getElementById('sev').value;

  out.innerHTML = '<em>Consultando...</em>';

  try {
    const url = `/check?tec=${encodeURIComponent(tec)}&ver=${encodeURIComponent(ver)}${sev ? `&sev=${encodeURIComponent(sev)}` : ''}`;
    const res = await fetch(url);
    const j = await res.json();
    if (!res.ok) throw new Error(j?.detalle || j?.error || res.statusText);

    const cvesHtml = (Array.isArray(j.cves) && j.cves.length)
      ? `<h4>CVEs encontrados (${j.cves.length})</h4><ul>` +
        j.cves.map(c => `<li>${sevTag(c.severity)} <a href="${c.url}" target="_blank">${c.id}</a> — score: ${c.score} — pub: ${fmtDate(c.published)}</li>`).join('') +
        `</ul>`
      : `<p class="muted"><em>Sin CVEs relevantes para el criterio seleccionado.</em></p>`;

    out.innerHTML = `
      <h3>${j.veredicto || 'Sin veredicto'}</h3>
      <p><strong>Tecnología:</strong> ${cap(j.tecnologia)} | <strong>Versión:</strong> ${j.version}</p>
      ${j.ciclo ? `<p><strong>Ciclo:</strong> ${j.ciclo.detectado||'-'} | <strong>EOL:</strong> ${fmtDate(j.ciclo.eol)} | <strong>Soporte:</strong> ${fmtDate(j.ciclo.support)} | <strong>Latest:</strong> ${j.ciclo.latest||'-'}</p>` : ''}
      <p><strong>Fuentes:</strong> ${j.fuentes?.map((f,i)=> `<a href="${f}" target="_blank">[${i+1}]</a>`).join(' ')}</p>
      ${cvesHtml}
    `;
  } catch (e) {
    out.innerHTML = `<p class="bad"><strong>Error:</strong> ${e.message}</p>`;
  }
});
</script>
</body>
</html>
